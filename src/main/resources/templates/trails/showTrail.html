<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="fragments/head :: head">
    <meta name="mapboxToken" th:content="${mapboxToken}">
    <title>Show Trail</title>
</head>
<body>
<nav th:replace="fragments/navbar :: navbar"></nav>
<main style="margin-top: 5rem">
    <div th:if="${trail == null}">
        <h1>Trail not found.</h1>
    </div>
    <div th:if="${trail != null}">
        <h1 th:text="${trail.name}"></h1>
        <h4 th:text="${trail.difficultyLevel}"></h4>
        <div th:if="${trail.rating != 0}">
            <h4 th:text="${'rating: ' + trail.rating}"></h4>
        </div>
        <div th:if="${trail.rating == 0}">
            <h4>No rating available</h4>
        </div>
        <h4 th:text="${'length: ' + trail.length + 'miles'}"></h4>
        <h4 th:text="${'elevation change: ' +  trail.elevation}"></h4>
        <h4 th:text="${'route type: ' +  trail.type}"></h4>
        <h4 th:text="${trail.trailDetails}"></h4>
        <div>
            <img th:each="image : ${trail.trailImages}" th:src="${image.pictureUrl}" alt="trail image">
        </div>

        <div th:if="${!trail.trailComments.isEmpty()}" th:each="comment : ${trail.trailComments}">
            Comments:
            <div>
                <img class="profileImage" th:src="${comment.owner.profileImageUrl}" alt="profile-image">
                <span th:text="${comment.owner.username}"></span>
            </div>
            <div>
                <span th:text="${comment.rating}"></span>  <span th:text="${comment.date}"></span>
            </div>
            <p th:text="${comment.content}"></p>
            <div sec:authorize="isAuthenticated()">
                <div th:if="${loggedInUser.isAdmin() || loggedInUser.id == comment.owner.id}">
                    <form th:action="@{/trails/{id}/comment/{cid}/delete(id=${trail.id},cid=${comment.id})}" method="post">
                        <button type="submit">Delete</button>
                    </form>
                </div>
            </div>
        </div>

    </div>

    <div sec:authorize="isAuthenticated()">
        <form th:action="@{/trails/{id}/comment(id=${trail.id})}" th:object="${trailComment}" th:method="POST">
            <div id="stars">Rating:
                <i class='fa fa-star star' data-value='1'></i>
                <i class='fa fa-star star' data-value='2'></i>
                <i class='fa fa-star star' data-value='3'></i>
                <i class='fa fa-star star' data-value='4'></i>
                <i class='fa fa-star star' data-value='5'></i>
            </div>
            <input type="hidden" id="rating" th:field="*{rating}">
            <textarea th:name="comment" cols="20" rows="10" th:field="*{content}"></textarea>
            <button type="submit">Submit</button>
        </form>
    </div>

    <div th:if="${trail.mapPoints.isEmpty() || trail.longitude == 0 || trail.latitude == 0}">
        No map available.
    </div>
    <div th:if="${!trail.mapPoints.isEmpty() && trail.longitude != 0 && trail.latitude != 0}">
        <input type="hidden" id="trailId" th:value="${trail.id}">
        <input type="hidden" id="trailLocation" th:value="${trail.longitude + ',' + trail.latitude}">
        <button class="btn" id="getMap">Get trail map</button>
        <div id="map"></div>
    </div>
</main>
<footer th:replace="fragments/footer :: footer"></footer>


<script th:inline="javascript">
    // assign mapboxToken to a variable
    const mapboxToken = [[${mapboxToken}]];
    console.log(mapboxToken);
</script>
<!-- Mapbox JS -->
<script src='https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.js'></script>
<!-- Mapbox Geocoder Util Methods -->
<script src="/js/mapbox-geocoder-utils.js"></script>
<script src="/js/showTrailMap.js"></script>
</body>
</html>
